CREATE TABLE SETOR (
    ID_SETOR NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    NOME_SETOR VARCHAR2(200) NOT NULL,
    BLOCO VARCHAR2(200),
    TIPO_SETOR VARCHAR2(200)
);

CREATE TABLE PACIENTE (
    ID_PACIENTE NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    NOME        VARCHAR2(200) NOT NULL,
    CPF         NUMBER UNIQUE NOT NULL,
    PLANO       VARCHAR2(200)
);

CREATE TABLE MEDICO (
    ID_MEDICO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    CRM       NUMBER UNIQUE NOT NULL,
    ESPECIALIDADE VARCHAR2(200)
);

CREATE TABLE ENFERMEIRO (
    ID_ENFERMEIRO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    NOME          VARCHAR2(200) NOT NULL,
    COREN         NUMBER UNIQUE NOT NULL,
    ID_SETOR      NUMBER,
    FOREIGN KEY (ID_SETOR) REFERENCES SETOR(ID_SETOR)
);

CREATE TABLE LEITO (
    ID_LEITO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    STATUS_LEITO VARCHAR2(200),
    ID_SETOR NUMBER NOT NULL,
    FOREIGN KEY (ID_SETOR) REFERENCES SETOR(ID_SETOR)
);

CREATE TABLE EXAME (
    ID_EXAME NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    NOME VARCHAR2(200) NOT NULL,
    TIPO_EXAME VARCHAR2(200) NOT NULL,
    DESCRICAO VARCHAR2(200)
);

CREATE TABLE ATENDIMENTO (
    ID_ATENDIMENTO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    AGENDAMENTO    VARCHAR2(200),
    DIAGNOSTICO    VARCHAR2(200),
    OBSERVACOES    VARCHAR2(200),

    ID_PACIENTE NUMBER NOT NULL,
    ID_MEDICO   NUMBER NOT NULL,
    ID_LEITO    NUMBER,

    FOREIGN KEY (ID_PACIENTE) REFERENCES PACIENTE(ID_PACIENTE),
    FOREIGN KEY (ID_MEDICO) REFERENCES MEDICO(ID_MEDICO),
    FOREIGN KEY (ID_LEITO) REFERENCES LEITO(ID_LEITO)
);

CREATE TABLE ATENDIMENTO_EXAME (
    ID_ATENDIMENTO_EXAME NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    DATA_SOLICITACAO DATE NOT NULL,

    ID_ATENDIMENTO NUMBER NOT NULL,
    ID_EXAME       NUMBER NOT NULL,

    FOREIGN KEY (ID_ATENDIMENTO) REFERENCES ATENDIMENTO(ID_ATENDIMENTO),
    FOREIGN KEY (ID_EXAME) REFERENCES EXAME(ID_EXAME)
);

CREATE TABLE ATENDIMENTO_ENFERMEIRO (
    ID_ATENDIMENTO_ENFERMEIRO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,

    ID_ATENDIMENTO NUMBER NOT NULL,
    ID_ENFERMEIRO  NUMBER NOT NULL,

    FOREIGN KEY (ID_ATENDIMENTO) REFERENCES ATENDIMENTO(ID_ATENDIMENTO),
    FOREIGN KEY (ID_ENFERMEIRO)  REFERENCES ENFERMEIRO(ID_ENFERMEIRO)
);

CREATE TABLE FINANCEIRO (
    ID_FINANCEIRO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ID_ATENDIMENTO NUMBER NOT NULL,
    VALOR NUMBER(10,2) NOT NULL,
    TIPO_PAGAMENTO VARCHAR2(200),

    FOREIGN KEY (ID_ATENDIMENTO) REFERENCES ATENDIMENTO(ID_ATENDIMENTO)
);


CREATE OR REPLACE TRIGGER TRG_DATA_SOLICITACAO_VALIDA
BEFORE INSERT OR UPDATE ON ATENDIMENTO_EXAME
FOR EACH ROW
BEGIN
    IF :NEW.DATA_SOLICITACAO > SYSDATE THEN
        RAISE_APPLICATION_ERROR(-20001, 'DATA_SOLICITACAO Não pode ser no futuro.');
        END IF;
END;
/

INSERT INTO SETOR (NOME_SETOR, BLOCO, TIPO_SETOR)
VALUES ('Emergencia', 'A', 'Atendimento');

SELECT ID_SETOR FROM SETOR;

INSERT INTO PACIENTE (NOME, CPF, PLANO)
VALUES ('Joao da Silva', 12345678900, 'Unimed');

SELECT ID_PACIENTE FROM PACIENTE;

INSERT INTO MEDICO (CRM, ESPECIALIDADE)
VALUES (12345, 'Clinico Geral');

SELECT ID_MEDICO FROM MEDICO;

INSERT INTO LEITO (STATUS_LEITO, ID_SETOR)
VALUES ('LIVRE', 1);

SELECT ID_LEITO FROM LEITO;

INSERT INTO ATENDIMENTO (
    AGENDAMENTO, DIAGNOSTICO, OBSERVACOES,
    ID_PACIENTE, ID_MEDICO, ID_LEITO
)
VALUES (
    'Consulta Geral', 'Dor de cabeca', 'Paciente estavel',
    1, 1, 1
);

SELECT ID_ATENDIMENTO FROM ATENDIMENTO;

INSERT INTO EXAME (NOME, TIPO_EXAME, DESCRICAO)
VALUES ('Exame de Sangue', 'Laboratorio', 'Hemograma Completo');

SELECT ID_EXAME FROM EXAME;

INSERT INTO ATENDIMENTO_EXAME (
    DATA_SOLICITACAO, ID_ATENDIMENTO, ID_EXAME
)
VALUES (
    TO_DATE('30/12/2099', 'DD/MM/YYYY'),
    1,
    1
);


INSERT INTO ATENDIMENTO_EXAME (
    DATA_SOLICITACAO, ID_ATENDIMENTO, ID_EXAME
)
VALUES (
    SYSDATE,
    1,
    1
);

ALTER SESSION SET NLS_DATE_FORMAT = 'DD/MM/YYYY HH24:MI:SS';

SELECT ID_ATENDIMENTO_EXAME, DATA_SOLICITACAO
FROM ATENDIMENTO_EXAME;

CREATE OR REPLACE TRIGGER TRG_OCUPAR_LEITO
AFTER INSERT ON ATENDIMENTO
FOR EACH ROW
BEGIN
    IF :NEW.ID_LEITO IS NOT NULL THEN
        UPDATE LEITO
        SET STATUS_LEITO = 'OCUPADO'
        WHERE ID_LEITO = :NEW.ID_LEITO;
    END IF;
END;
/

INSERT INTO ATENDIMENTO (
    AGENDAMENTO, DIAGNOSTICO, OBSERVACOES,
    ID_PACIENTE, ID_MEDICO, ID_LEITO
)
VALUES (
    'Retorno', 'Dor', 'Teste',
    1, 1, 1
);

SELECT STATUS_LEITO FROM LEITO WHERE ID_LEITO = 1;

CREATE OR REPLACE TRIGGER TRG_IMPEDIR_LEITO_OCUPADO
BEFORE INSERT OR UPDATE ON ATENDIMENTO
FOR EACH ROW
DECLARE
    v_status VARCHAR2(200);
BEGIN
    IF: NEW.ID_LEITO IS NOT NULL THEN
    SELECT STATUS_LEITO
    INTO v_status
    FROM LEITO
    WHERE ID_LEITO = :NEW.ID_LEITO;

    -- Se estiver ocupado, proibir
    IF v_status = 'OCUPADO' THEN
    RAISE_APPLICATION_ERROR(-20002, 'Este leito se encontra OCUPADO');
    END IF;
    END IF;
END;
/

INSERT INTO ATENDIMENTO (
    AGENDAMENTO, DIAGNOSTICO, OBSERVACOES,
    ID_PACIENTE, ID_MEDICO, ID_LEITO
)
VALUES ('Primeiro Teste', 'Ok', 'Ok', 1, 1, 1);

INSERT INTO ATENDIMENTO (
    AGENDAMENTO, DIAGNOSTICO, OBSERVACOES,
    ID_PACIENTE, ID_MEDICO, ID_LEITO
)
VALUES ('Segundo Teste', 'Ok', 'Ok', 1, 1, 1);

CREATE OR REPLACE TRIGGER TRG_IMPEDIR_DELETE_PACIENTE
BEFORE DELETE ON PACIENTE
FOR EACH ROW
DECLARE
    v_contador NUMBER;
BEGIN

    -- Verificar se existe atendimento associado ao paciente
    SELECT COUNT(*)
    INTO v_contador
    FROM ATENDIMENTO
    WHERE ID_PACIENTE = :OLD.ID_PACIENTE;

    -- Se houver atendimentos, impedir a exclusão
    IF v_contador > 0 THEN
    RAISE_APPLICATION_ERROR(
        -20003,
        'Não é possível excluir este PACIENTE: existem atendimentos vinculados.'
    );
    END IF;
END;
/

DELETE FROM PACIENTE
WHERE ID_PACIENTE = 1;

ALTER TABLE ATENDIMENTO
ADD DATA_ALTA DATE;

CREATE OR REPLACE TRIGGER TRG_REGISTRAR_DATA_ALTA
BEFORE UPDATE ON ATENDIMENTO
FOR EACH ROW
BEGIN
    -- Se houver alteração indicando ALTA
    IF UPPER(:NEW.OBSERVACOES) LIKE '%ALTA%'
    AND :OLD.DATA_ALTA IS NULL THEN

    -- Preencher automaticamente a data da alta
    :NEW.DATA_ALTA := SYSDATE;
    END IF;
END;
/
    -- Teste
SELECT ID_ATENDIMENTO, DATA_ALTA
FROM ATENDIMENTO
WHERE ID_ATENDIMENTO = 1;

UPDATE ATENDIMENTO
SET OBSERVACOES = 'Paciente recebeu alta'
WHERE ID_ATENDIMENTO = 1;

CREATE OR REPLACE TRIGGER TRG_IMPEDIR_LEITO_OCUPADO
BEFORE INSERT OR UPDATE OF ID_LEITO ON ATENDIMENTO
FOR EACH ROW
DECLARE
    v_status VARCHAR2(200);
BEGIN
    -- Só verifica quando o ID_LEITO for alterado
    IF :NEW.ID_LEITO IS NOT NULL AND :NEW.ID_LEITO != :OLD.ID_LEITO THEN

        -- Buscar status atual do leito
        SELECT STATUS_LEITO
        INTO v_status
        FROM LEITO
        WHERE ID_LEITO = :NEW.ID_LEITO;

        -- Se estiver ocupado, impedir troca
        IF v_status = 'OCUPADO' THEN
            RAISE_APPLICATION_ERROR(
                -20002,
                'Este leito já está OCUPADO.'
            );
        END IF;

    END IF;
END;
/

UPDATE ATENDIMENTO
SET OBSERVACOES = 'Paciente recebeu alta'
WHERE ID_ATENDIMENTO = 1;

SELECT ID_ATENDIMENTO, DATA_ALTA
FROM ATENDIMENTO
WHERE ID_ATENDIMENTO = 1;

CREATE TABLE HISTORICO_ATENDIMENTO (
    ID_HISTORICO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ID_ATENDIMENTO NUMBER NOT NULL,
    CAMPO_ALTERADO VARCHAR2(200),
    VALOR_ANTIGO VARCHAR2(200),
    VALOR_NOVO VARCHAR2(200),
    DATA_ALTERACAO DATE DEFAULT SYSDATE,

    FOREIGN KEY (ID_ATENDIMENTO) REFERENCES ATENDIMENTO(ID_ATENDIMENTO)
);

CREATE OR REPLACE TRIGGER TRG_HISTORICO_ATENDIMENTO
AFTER UPDATE ON ATENDIMENTO
FOR EACH ROW
BEGIN
    -- Se o diagnóstico mudou
    IF :OLD.DIAGNOSTICO != :NEW.DIAGNOSTICO THEN
        INSERT INTO HISTORICO_ATENDIMENTO (
            ID_ATENDIMENTO, CAMPO_ALTERADO, VALOR_ANTIGO, VALOR_NOVO
        ) VALUES (
            :OLD.ID_ATENDIMENTO, 
            'DIAGNOSTICO',
            :OLD.DIAGNOSTICO,
            :NEW.DIAGNOSTICO
        );
    END IF;

    -- Se as observações mudaram
    IF :OLD.OBSERVACOES != :NEW.OBSERVACOES THEN
        INSERT INTO HISTORICO_ATENDIMENTO (
            ID_ATENDIMENTO, CAMPO_ALTERADO, VALOR_ANTIGO, VALOR_NOVO
        ) VALUES (
            :OLD.ID_ATENDIMENTO, 
            'OBSERVACOES',
            :OLD.OBSERVACOES,
            :NEW.OBSERVACOES
        );
    END IF;
END;
/

UPDATE ATENDIMENTO
SET DIAGNOSTICO = 'Gripe forte'
WHERE ID_ATENDIMENTO = 1;

SELECT ID_ATENDIMENTO, CAMPO_ALTERADO, VALOR_ANTIGO, VALOR_NOVO, DATA_ALTERACAO
FROM HISTORICO_ATENDIMENTO;

CREATE TABLE HISTORICO_FINANCEIRO (
    ID_HISTORICO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    ID_FINANCEIRO NUMBER NOT NULL,
    CAMPO_ALTERADO VARCHAR2(200),
    VALOR_ANTIGO VARCHAR2(200),
    VALOR_NOVO VARCHAR2(200),
    DATA_ALTERACAO DATE DEFAULT SYSDATE,

    FOREIGN KEY (ID_FINANCEIRO) REFERENCES FINANCEIRO(ID_FINANCEIRO)
);

CREATE OR REPLACE TRIGGER TRG_AUDITORIA_FINANCEIRO
AFTER UPDATE ON FINANCEIRO
FOR EACH ROW
BEGIN
    -- Caso o VALOR seja alterado
    IF :OLD.VALOR != :NEW.VALOR THEN
        INSERT INTO HISTORICO_FINANCEIRO (
            ID_FINANCEIRO, CAMPO_ALTERADO, VALOR_ANTIGO, VALOR_NOVO
        ) VALUES (
            :OLD.ID_FINANCEIRO,
            'VALOR',
            TO_CHAR(:OLD.VALOR),
            TO_CHAR(:NEW.VALOR)
        );
    END IF;

    -- Caso o TIPO_PAGAMENTO seja alterado
    IF :OLD.TIPO_PAGAMENTO != :NEW.TIPO_PAGAMENTO THEN
        INSERT INTO HISTORICO_FINANCEIRO (
            ID_FINANCEIRO, CAMPO_ALTERADO, VALOR_ANTIGO, VALOR_NOVO
        ) VALUES (
            :OLD.ID_FINANCEIRO,
            'TIPO_PAGAMENTO',
            :OLD.TIPO_PAGAMENTO,
            :NEW.TIPO_PAGAMENTO
        );
    END IF;
END;
/

INSERT INTO FINANCEIRO (ID_ATENDIMENTO, VALOR, TIPO_PAGAMENTO)
VALUES (1, 200.00, 'PIX');

SELECT ID_FINANCEIRO FROM FINANCEIRO;

CREATE OR REPLACE PROCEDURE CADASTRAR_PACIENTE (
    p_nome  IN  VARCHAR2,
    p_cpf   IN  NUMBER,
    p_plano IN  VARCHAR2
) AS
    v_count NUMBER;
BEGIN
    SELECT COUNT(*) INTO v_count FROM PACIENTE WHERE CPF = p_cpf;
    
    IF v_count > 0 THEN
        RAISE_APPLICATION_ERROR(-20010, 'CPF já cadastrado.');
    END IF;

    INSERT INTO PACIENTE (NOME, CPF, PLANO)
    VALUES (p_nome, p_cpf, p_plano);

    COMMIT;

EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

EXEC CADASTRAR_PACIENTE('Maria de Souza', 55555555555, 'Unimed');

CREATE OR REPLACE PROCEDURE AGENDAR_ATENDIMENTO (
    p_agendamento   IN VARCHAR2,
    p_diagnostico   IN VARCHAR2,
    p_observacoes   IN VARCHAR2,
    p_id_paciente   IN NUMBER,
    p_id_medico     IN NUMBER,
    p_id_leito      IN NUMBER DEFAULT NULL
) AS
    v_exists NUMBER;
    v_status VARCHAR2(200);
BEGIN
    -- Validar paciente
    SELECT COUNT(*) INTO v_exists FROM PACIENTE WHERE ID_PACIENTE = p_id_paciente;
    IF v_exists = 0 THEN
        RAISE_APPLICATION_ERROR(-20011, 'Paciente inexistente.');
    END IF;

    -- Validar médico
    SELECT COUNT(*) INTO v_exists FROM MEDICO WHERE ID_MEDICO = p_id_medico;
    IF v_exists = 0 THEN
        RAISE_APPLICATION_ERROR(-20012, 'Médico inexistente.');
    END IF;

    -- Validar leito
    IF p_id_leito IS NOT NULL THEN
        SELECT STATUS_LEITO INTO v_status
        FROM LEITO
        WHERE ID_LEITO = p_id_leito
        FOR UPDATE;

        IF v_status = 'OCUPADO' THEN
            RAISE_APPLICATION_ERROR(-20013, 'Leito já está ocupado.');
        END IF;
    END IF;

    INSERT INTO ATENDIMENTO (
        AGENDAMENTO, DIAGNOSTICO, OBSERVACOES,
        ID_PACIENTE, ID_MEDICO, ID_LEITO
    )
    VALUES (
        p_agendamento, p_diagnostico, p_observacoes,
        p_id_paciente, p_id_medico, p_id_leito
    );

    COMMIT;

EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/

BEGIN
    CADASTRAR_PACIENTE('Maria de Souza', 55555555555, 'Unimed');
END;
/

CREATE OR REPLACE VIEW VW_RESUMO_ATENDIMENTO AS
SELECT 
    A.ID_ATENDIMENTO,
    P.NOME AS NOME_PACIENTE,
    M.CRM AS CRM_MEDICO,
    M.ESPECIALIDADE,
    A.DIAGNOSTICO,
    A.OBSERVACOES,
    A.AGENDAMENTO,
    A.DATA_ALTA,
    L.ID_LEITO,
    L.STATUS_LEITO
FROM ATENDIMENTO A
JOIN PACIENTE P ON A.ID_PACIENTE = P.ID_PACIENTE
JOIN MEDICO M ON A.ID_MEDICO = M.ID_MEDICO
LEFT JOIN LEITO L ON A.ID_LEITO = L.ID_LEITO;

SELECT ID_ATENDIMENTO, NOME_PACIENTE, CRM_MEDICO
FROM VW_RESUMO_ATENDIMENTO;

CREATE OR REPLACE VIEW VW_OCUPACAO_LEITOS AS
SELECT 
    S.NOME_SETOR,
    S.BLOCO,
    L.ID_LEITO,
    L.STATUS_LEITO
FROM LEITO L
JOIN SETOR S ON L.ID_SETOR = S.ID_SETOR;

SELECT NOME_SETOR, BLOCO, ID_LEITO, STATUS_LEITO
FROM VW_OCUPACAO_LEITOS;

CREATE OR REPLACE VIEW VW_HISTORICO_ATENDIMENTO AS
SELECT 
    H.ID_HISTORICO,
    H.ID_ATENDIMENTO,
    H.CAMPO_ALTERADO,
    H.VALOR_ANTIGO,
    H.VALOR_NOVO,
    H.DATA_ALTERACAO
FROM HISTORICO_ATENDIMENTO H;

SELECT * FROM VW_HISTORICO_ATENDIMENTO WHERE ID_ATENDIMENTO = 1;

CREATE OR REPLACE VIEW VW_FINANCEIRO_RESUMO AS
SELECT
    F.ID_FINANCEIRO,
    F.ID_ATENDIMENTO,
    P.NOME AS NOME_PACIENTE,
    M.CRM AS CRM_MEDICO,
    F.VALOR,
    F.TIPO_PAGAMENTO,
    A.DIAGNOSTICO,
    L.ID_LEITO,
    S.NOME_SETOR AS SETOR
FROM FINANCEIRO F
JOIN ATENDIMENTO A ON F.ID_ATENDIMENTO = A.ID_ATENDIMENTO
JOIN PACIENTE P ON A.ID_PACIENTE = P.ID_PACIENTE
JOIN MEDICO M ON A.ID_MEDICO = M.ID_MEDICO
LEFT JOIN LEITO L ON A.ID_LEITO = L.ID_LEITO
LEFT JOIN SETOR S ON L.ID_SETOR = S.ID_SETOR;

SELECT 
    ID_ATENDIMENTO,
    NOME_PACIENTE,
    VALOR,
    TIPO_PAGAMENTO,
    SETOR
FROM VW_FINANCEIRO_RESUMO;

ALTER TABLE PACIENTE 
ADD DATA_NASCIMENTO DATE;

UPDATE PACIENTE 
SET DATA_NASCIMENTO = TO_DATE('12/05/2000', 'DD/MM/YYYY')
WHERE ID_PACIENTE = 1;

CREATE OR REPLACE FUNCTION FN_CALCULA_IDADE (p_id_paciente NUMBER)
RETURN NUMBER
AS
    v_data_nasc DATE;
    v_idade NUMBER;
BEGIN
    -- Buscar a data de nascimento
    SELECT DATA_NASCIMENTO 
    INTO v_data_nasc
    FROM PACIENTE
    WHERE ID_PACIENTE = p_id_paciente;

    -- Calcular a idade
    v_idade := TRUNC(MONTHS_BETWEEN(SYSDATE, v_data_nasc) / 12);

    RETURN v_idade;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20020, 'Paciente não encontrado.');
END;
/

SELECT FN_CALCULA_IDADE(1) FROM dual;

CREATE OR REPLACE FUNCTION FN_TOTAL_EXAMES_ATENDIMENTO (p_id_atendimento NUMBER)
RETURN NUMBER
AS
    v_total NUMBER := 0;
BEGIN
    SELECT SUM(E.VALOR)
    INTO v_total
    FROM ATENDIMENTO_EXAME AE
    JOIN EXAME E ON AE.ID_EXAME = E.ID_EXAME
    WHERE AE.ID_ATENDIMENTO = p_id_atendimento;

    RETURN NVL(v_total, 0);
END;
/

CREATE OR REPLACE FUNCTION FN_LEITO_LIVRE (p_id_leito NUMBER)
RETURN NUMBER
AS
    v_status VARCHAR2(200);
BEGIN
    SELECT STATUS_LEITO
    INTO v_status
    FROM LEITO
    WHERE ID_LEITO = p_id_leito;

    IF v_status = 'LIVRE' THEN
        RETURN 1;
    ELSE
        RETURN 0;
    END IF;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RETURN 0;
END;
/

CREATE OR REPLACE PACKAGE PKG_HOSPITAL AS
    
    -- Funções
    FUNCTION FN_CALCULA_IDADE (p_id_paciente NUMBER) RETURN NUMBER;
    FUNCTION FN_LEITO_LIVRE (p_id_leito NUMBER) RETURN NUMBER;

    -- Procedures
    PROCEDURE CADASTRAR_PACIENTE (
        p_nome  IN  VARCHAR2,
        p_cpf   IN  NUMBER,
        p_plano IN  VARCHAR2,
        p_data_nasc IN DATE
    );

    PROCEDURE AGENDAR_ATENDIMENTO (
        p_agendamento   IN VARCHAR2,
        p_diagnostico   IN VARCHAR2,
        p_observacoes   IN VARCHAR2,
        p_id_paciente   IN NUMBER,
        p_id_medico     IN NUMBER,
        p_id_leito      IN NUMBER DEFAULT NULL
    );

    PROCEDURE LIBERAR_LEITO (p_id_leito NUMBER);

    PROCEDURE DAR_ALTA (p_id_atendimento NUMBER);

END PKG_HOSPITAL;
/

CREATE OR REPLACE PACKAGE BODY PKG_HOSPITAL AS

    -- FUNÇÃO 1: idade do paciente

    FUNCTION FN_CALCULA_IDADE (p_id_paciente NUMBER)
    RETURN NUMBER AS
        v_data DATE;
    BEGIN
        SELECT DATA_NASCIMENTO INTO v_data
        FROM PACIENTE
        WHERE ID_PACIENTE = p_id_paciente;

        RETURN TRUNC(MONTHS_BETWEEN(SYSDATE, v_data) / 12);
    END FN_CALCULA_IDADE;

    -- FUNÇÃO 2: leito livre

    FUNCTION FN_LEITO_LIVRE (p_id_leito NUMBER)
    RETURN NUMBER AS
        v_status VARCHAR2(200);
    BEGIN
        SELECT STATUS_LEITO INTO v_status
        FROM LEITO
        WHERE ID_LEITO = p_id_leito;

        IF v_status = 'LIVRE' THEN
            RETURN 1;
        ELSE
            RETURN 0;
        END IF;
    END FN_LEITO_LIVRE;

    -- PROCEDURE: cadastrar paciente

    PROCEDURE CADASTRAR_PACIENTE (
        p_nome  IN  VARCHAR2,
        p_cpf   IN  NUMBER,
        p_plano IN  VARCHAR2,
        p_data_nasc IN DATE
    ) AS
        v_count NUMBER;
    BEGIN
        SELECT COUNT(*) INTO v_count FROM PACIENTE WHERE CPF = p_cpf;
        IF v_count > 0 THEN
            RAISE_APPLICATION_ERROR(-20010, 'CPF já cadastrado.');
        END IF;

        INSERT INTO PACIENTE (NOME, CPF, PLANO, DATA_NASCIMENTO)
        VALUES (p_nome, p_cpf, p_plano, p_data_nasc);

        COMMIT;
    END CADASTRAR_PACIENTE;

    -- PROCEDURE: agendar atendimento

    PROCEDURE AGENDAR_ATENDIMENTO (
        p_agendamento   IN VARCHAR2,
        p_diagnostico   IN VARCHAR2,
        p_observacoes   IN VARCHAR2,
        p_id_paciente   IN NUMBER,
        p_id_medico     IN NUMBER,
        p_id_leito      IN NUMBER DEFAULT NULL
    ) AS
        v_status VARCHAR2(200);
    BEGIN
        IF p_id_leito IS NOT NULL THEN
            SELECT STATUS_LEITO INTO v_status
            FROM LEITO
            WHERE ID_LEITO = p_id_leito
            FOR UPDATE;

            IF v_status = 'OCUPADO' THEN
                RAISE_APPLICATION_ERROR(-20015, 'Leito ocupado.');
            END IF;
        END IF;

        INSERT INTO ATENDIMENTO (
            AGENDAMENTO, DIAGNOSTICO, OBSERVACOES,
            ID_PACIENTE, ID_MEDICO, ID_LEITO
        ) VALUES (
            p_agendamento, p_diagnostico, p_observacoes,
            p_id_paciente, p_id_medico, p_id_leito
        );

        COMMIT;
    END AGENDAR_ATENDIMENTO;

    -- PROCEDURE: liberar leito

    PROCEDURE LIBERAR_LEITO (p_id_leito NUMBER) AS
    BEGIN
        UPDATE LEITO
        SET STATUS_LEITO = 'LIVRE'
        WHERE ID_LEITO = p_id_leito;

        COMMIT;
    END LIBERAR_LEITO;

    -- PROCEDURE: dar alta

    PROCEDURE DAR_ALTA (p_id_atendimento NUMBER) AS
    BEGIN
        UPDATE ATENDIMENTO
        SET OBSERVACOES = 'Paciente recebeu alta'
        WHERE ID_ATENDIMENTO = p_id_atendimento;

        COMMIT;
    END DAR_ALTA;

END PKG_HOSPITAL;
/

SELECT 
    A.ID_ATENDIMENTO,
    P.NOME AS PACIENTE,
    M.ESPECIALIDADE AS MEDICO,
    L.ID_LEITO,
    S.NOME_SETOR,
    A.DIAGNOSTICO
FROM ATENDIMENTO A
JOIN PACIENTE P ON A.ID_PACIENTE = P.ID_PACIENTE
JOIN MEDICO M ON A.ID_MEDICO = M.ID_MEDICO
LEFT JOIN LEITO L ON A.ID_LEITO = L.ID_LEITO
LEFT JOIN SETOR S ON L.ID_SETOR = S.ID_SETOR;

SELECT 
    S.NOME_SETOR,
    COUNT(*) AS TOTAL_ATENDIMENTOS
FROM ATENDIMENTO A
JOIN LEITO L ON A.ID_LEITO = L.ID_LEITO
JOIN SETOR S ON L.ID_SETOR = S.ID_SETOR
GROUP BY S.NOME_SETOR
HAVING COUNT(*) > 0;

SELECT 
    P.NOME,
    COUNT(A.ID_ATENDIMENTO) AS QTD_ATENDIMENTOS
FROM PACIENTE P
JOIN ATENDIMENTO A ON A.ID_PACIENTE = P.ID_PACIENTE
GROUP BY P.NOME
HAVING COUNT(A.ID_ATENDIMENTO) > 1;

SELECT 
    L.ID_LEITO,
    L.STATUS_LEITO,
    S.NOME_SETOR
FROM LEITO L
JOIN SETOR S ON L.ID_SETOR = S.ID_SETOR
WHERE L.STATUS_LEITO = 'OCUPADO';

SELECT 
    TIPO_PAGAMENTO,
    SUM(VALOR) AS TOTAL
FROM FINANCEIRO
GROUP BY TIPO_PAGAMENTO;

SELECT 
    P.ID_PACIENTE,
    P.NOME
FROM PACIENTE P
WHERE NOT EXISTS (
    SELECT 1
    FROM ATENDIMENTO A
    WHERE A.ID_PACIENTE = P.ID_PACIENTE
);

CREATE INDEX IDX_ATEND_PACIENTE 
ON ATENDIMENTO(ID_PACIENTE);

CREATE INDEX IDX_ATEND_MEDICO 
ON ATENDIMENTO(ID_MEDICO);

SELECT /*+ FULL(P) */ 
    P.NOME, A.DIAGNOSTICO
FROM PACIENTE P
JOIN ATENDIMENTO A ON A.ID_PACIENTE = P.ID_PACIENTE;
